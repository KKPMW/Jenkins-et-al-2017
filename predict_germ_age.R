predict_germ_age <- function(x, probeID, batch=1) {

  x <- as.matrix(x)
  stopifnot(is.numeric(x))
  stopifnot(length(probeID)==nrow(x))
  stopifnot(length(batch) %in% c(1, ncol(x)))

  # list of region probe IDs
  # NOTE: For some reason N29 is present but not used in the model
  regions <- list(ELANE        = c("cg01963696", "cg06100973", "cg03633458", "cg04382396"),
                  FSCN         = c("cg15246238", "cg12600030", "cg24239690"),
                  GPR45        = c("cg08008105", "cg02571972", "cg09510339", "cg27229823", "cg01046703", "cg21399079", "cg18338460", "cg02858997", "cg22253945", "cg06061408", "cg11565042", "cg03722643"),
                  MIR22HG      = c("cg26697882", "cg00956971", "cg06927305", "cg22516975", "cg19015264"),
                  N23          = c("cg10024437", "cg26297506", "cg07458849"),
                  # N29          = c("cg25321885", "cg18075379", "cg03922946"),
                  PTPRN2.3     = c("cg23375968", "cg12297440", "cg04237822", "cg18479082"),
                  ARC          = c("cg24450303", "cg13172906", "cg05415840", "cg08387463"),
                  NSG1         = c("cg01159601", "cg05274323", "cg12235062", "cg23690904"),
                  THBS3        = c("cg12543649", "cg25912717", "cg01428953", "cg16416987", "cg02516288"),
                  CLIC1        = c("cg03980764", "cg18402034", "cg03329603", "cg00657529", "cg14647877", "cg12216180", "cg04387059", "cg05157492", "cg07404514", "cg11093373", "cg02272213"),
                  GET4         = c("cg01259220", "cg24580076", "cg01028223", "cg07243405", "cg04220579", "cg17052926", "cg17620121"),
                  LOC100133461 = c("cg15875904", "cg18976355", "cg04638766"),
                  N12          = c("cg00649480", "cg02610486", "cg04144394", "cg05007442"),
                  N22          = c("cg22634611", "cg27296963", "cg05956273"),
                  N24          = c("cg16306083", "cg14218838", "cg00929465"),
                  NCOR2        = c("cg09825309", "cg22700848", "cg04403415", "cg27179101"),
                  PAX2         = c("cg17861154", "cg17589590", "cg09073539", "cg07214490"),
                  PRSS22       = c("cg00699901", "cg21452411", "cg27620871", "cg02256969", "cg19328294", "cg05895034", "cg09745688", "cg05490519"),
                  SECTM1       = c("cg11740099", "cg03325767", "cg19930417", "cg04546616", "cg14728380"),
                  SEMA6B       = c("cg06915470", "cg25655324", "cg19823504"),
                  SEZ6         = c("cg17477442", "cg14539210", "cg17800497", "cg22981628"),
                  SOHLH1       = c("cg13558241", "cg14393817", "cg14159004", "cg00332421"),
                  ARGHGEF10    = c("cg07694735", "cg06807837", "cg01824603"),
                  ADAMTS8      = c("cg06944693", "cg01260219", "cg12270485"),
                  BCL11A       = c("cg23556108", "cg22445742", "cg15241316"),
                  C1ORF122     = c("cg00095214", "cg10981770", "cg04411969", "cg11136250"),
                  C7ORF50      = c("cg06458707", "cg08973950", "cg19254152", "cg23498771", "cg16689048"),
                  CCDC144NL    = c("cg06633402", "cg18251984", "cg08458692", "cg14560110", "cg22516161", "cg08288433", "cg06809326", "cg22570042", "cg21980100", "cg25893857", "cg11633473", "cg22282896"),
                  DMPK         = c("cg06710981", "cg18511790", "cg08332594"),
                  FAM86C1      = c("cg10565270", "cg04310266", "cg24620338", "cg01490535", "cg05097696"),
                  FAM86JP      = c("cg18994377", "cg08610802", "cg02633309", "cg03500585"),
                  FOXK1        = c("cg04160501", "cg22218709", "cg22846826"),
                  GAPDH        = c("cg25252598", "cg02971381", "cg15350627", "cg00252813", "cg02519286"),
                  GNB2         = c("cg27369641", "cg03324851", "cg17854981", "cg16177440"),
                  GPANK1       = c("cg08502159", "cg11569933", "cg08566449", "cg04477431", "cg16220567", "cg06473363", "cg06670599", "cg17422460", "cg09314434", "cg26467528", "cg00171725", "cg27105577", "cg27323011", "cg06518831"),
                  KCNQ1        = c("cg27491887", "cg04608933", "cg18729298", "cg07824422", "cg02258534", "cg05898618"),
                  LDLRAD4      = c("cg14825976", "cg25374649", "cg22454011", "cg14846965", "cg15056105", "cg00737978", "cg24404630"),
                  LMO3         = c("cg19016652", "cg14905657", "cg26575637", "cg06528626"),
                  MTMR8        = c("cg14961598", "cg16251458", "cg26122495", "cg12312457", "cg16718054", "cg14247154", "cg09406238", "cg05462236", "cg03817616"),
                  N10          = c("cg03765260", "cg17037018", "cg20945221", "cg16411683"),
                  N27          = c("cg00744791", "cg11384481", "cg16459276"),
                  N30          = c("cg04426109", "cg23412820", "cg13895409", "cg00090521", "cg02814552"),
                  N8           = c("cg22111527", "cg03371384", "cg12889594", "cg17007896"),
                  N9           = c("cg02992762", "cg12837463", "cg17698366", "cg13421062"),
                  NONE         = c("cg26654358", "cg12722935", "cg03830712"),
                  PITX1        = c("cg18606375", "cg03347590", "cg21614303", "cg02213684"),
                  PTPRN2.4     = c("cg26689848", "cg22730626", "cg13900349", "cg10754395", "cg09017928", "cg22530232"),
                  PURA         = c("cg00079023", "cg00534655", "cg27111970", "cg23160717", "cg00042246"),
                  PYY2         = c("cg03924483", "cg19539519", "cg25191725", "cg11231143"),
                  SLC22A18AS   = c("cg23335134", "cg26874323", "cg08222610"),
                  TNXB         = c("cg15014577", "cg18102337", "cg01033871", "cg05889186", "cg15745284", "cg07518714", "cg00355613", "cg10783204", "cg07237769", "cg17066403", "cg04037640", "cg26476939", "cg14062899", "cg01785906", "cg04272615")
                  )

  # get region averages
  get_region_average <- function(regs, probes, x) {
    colMeans(x[probes %in% regs,,drop=FALSE], na.rm=TRUE)
  }
  dat <- mapply(get_region_average, regions, list(probeID), list(x))

  # fix NA values by adding mean
  dat[is.na(dat)] <- mean(dat, na.rm=TRUE)

  # add batch variable
  dat <- cbind(BATCH=as.numeric(batch), dat)

  # model coefficients for each region
  coefs <- c(Intercept    =  41.50292008994122028,
             BATCH        =   0.00000000004682266,
             ELANE        =   5.11698490160151565,
             FSCN         =  -0.87964760294545974,
             GPR45        =   4.96425928872832234,
             MIR22HG      =  -5.61698535969070001,
             N23          =   9.12093118786285828,
             PTPRN2.3     =  -2.61498934534021288,
             ARC          =  14.12595754448367913,
             NSG1         =  25.46141722116914963,
             THBS3        =  -7.82753434357674660,
             CLIC1        =  25.64681518969138097,
             GET4         = -14.74755920508500218,
             LOC100133461 = -10.99488490573257238,
             N12          =  12.20669474186209591,
             N22          =  -3.75795569869490675,
             N24          =  -3.32297695433986817,
             NCOR2        =  -2.16209057796202986,
             PAX2         =  11.11854284822326377,
             PRSS22       = -14.25262128882299351,
             SECTM1       =  11.20971729982653287,
             SEMA6B       =  12.39121605158566553,
             SEZ6         = -30.96600076607253627,
             SOHLH1       =  13.93188385467777834,
             ARGHGEF10    =  -2.63074704815212312,
             ADAMTS8      = -25.68463630590140667,
             BCL11A       =  13.61755117104186752,
             C1ORF122     = -16.23382867363589810,
             C7ORF50      = -12.69268736055783009,
             CCDC144NL    =  10.97165330699551156,
             DMPK         = -13.64509539935605886,
             FAM86C1      =  13.08948091105399847,
             FAM86JP      =  13.80442089112550264,
             FOXK1        =  -1.86967383105158191,
             GAPDH        = -13.43985714386649200,
             GNB2         =  10.13587364761846565,
             GPANK1       =  -9.01844411522847800,
             KCNQ1        =  -3.91590522261048291,
             LDLRAD4      =  -7.41108094674322970,
             LMO3         =  -9.46219889894234356,
             MTMR8        =  57.12002332468856736,
             N10          = -19.21540833000476667,
             N27          =  -8.15722323217271317,
             N30          =  -8.11982689687612336,
             N8           =  23.38944286273764561,
             N9           = -15.60667693108966247,
             NONE         =   8.79462259804691548,
             PITX1        = -16.83781326156590907,
             PTPRN2.4     =  -4.06097359069870834,
             PURA         =  -6.62297717197403202,
             PYY2         =  -3.88857899988800382,
             SLC22A18AS   = -11.61662648612768045,
             TNXB         = -20.06229072091414523
             )

  # predict age
  pred_age <- coefs %*% t(cbind(1, dat[,names(coefs)[-1]]))
  as.numeric(pred_age)
}

